<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Escape Room Â· El Castell dels Morley Â· 2n ESO</title>
<style>
  /* â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: radial-gradient(ellipse at 20% 20%, #1e0a3c 0%, #050714 50%, #000 100%);
    color: #e2e8f0;
    min-height: 100vh;
  }

  /* â”€â”€ ANIMATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @keyframes fadeIn   { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
  @keyframes fadeOut  { from { opacity:1; } to { opacity:0; } }
  @keyframes shake    { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-8px)} 40%{transform:translateX(8px)} 60%{transform:translateX(-5px)} 80%{transform:translateX(5px)} }
  @keyframes flicker  { 0%,100%{opacity:.9} 50%{opacity:.5} }
  @keyframes pulse    { 0%,100%{opacity:.4} 50%{opacity:1} }
  @keyframes float    { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
  @keyframes wave     { 0%,100%{d:path("M0 10 C150 0,350 20,540 8 C700 -2,820 14,900 6 L900 30 L0 30Z")} 50%{d:path("M0 12 C150 4,350 16,540 10 C700 2,820 12,900 8 L900 30 L0 30Z")} }
  @keyframes shimmer  { 0%,100%{opacity:.12} 50%{opacity:.04} }
  @keyframes blink    { 0%,100%{opacity:.8} 50%{opacity:.1} }
  @keyframes spin     { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
  @keyframes progress { from{width:0%} to{width:var(--target-width)} }
  @keyframes drip     { 0%,100%{transform:translateY(0);opacity:.6} 50%{transform:translateY(10px);opacity:0} }
  @keyframes dash     { to{stroke-dashoffset:-20} }

  /* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #app { max-width: 1100px; margin: 0 auto; padding: 20px 16px; }

  /* â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .topbar {
    background: rgba(8,9,26,.85); backdrop-filter:blur(20px);
    border: 1px solid rgba(255,255,255,.07);
    border-radius: 16px; padding: 16px 24px; margin-bottom: 20px;
    display: flex; flex-wrap: wrap; align-items: center;
    justify-content: space-between; gap: 16px;
  }
  .topbar-logo {
    width:44px;height:44px;
    background:linear-gradient(135deg,#7C3AED,#BE185D);
    border-radius:12px;display:flex;align-items:center;
    justify-content:center;font-size:22px;
    box-shadow:0 4px 20px #7C3AED44;flex-shrink:0;
  }
  .topbar-title { font-size:16px;font-weight:900;letter-spacing:-.02em;color:#f1f5f9; }
  .topbar-sub   { font-size:11px;color:#64748b;margin-top:2px; }
  .progress-bar-wrap { min-width:160px; }
  .progress-labels { display:flex;justify-content:space-between;color:#64748b;font-size:11px;margin-bottom:5px; }
  .progress-track { height:6px;background:#1e293b;border-radius:99px;overflow:hidden; }
  .progress-fill  { height:100%;background:linear-gradient(90deg,#7C3AED,#BE185D);border-radius:99px;transition:width .5s ease; }
  .btn-reset {
    background:#1e293b;border:1px solid #334155;border-radius:10px;
    padding:9px 14px;color:#94a3b8;font-size:12px;font-weight:600;
    cursor:pointer;display:flex;align-items:center;gap:6px;
    transition:color .15s,border-color .15s;
  }
  .btn-reset:hover { color:#e2e8f0;border-color:#475569; }

  /* â”€â”€ GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main-grid { display:grid;grid-template-columns:250px 1fr;gap:20px;align-items:start; }
  @media(max-width:700px){ .main-grid{grid-template-columns:1fr;} }

  /* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sidebar {
    background:rgba(8,9,26,.85);backdrop-filter:blur(20px);
    border:1px solid rgba(255,255,255,.07);border-radius:16px;
    overflow:hidden;position:sticky;top:16px;
  }
  .sidebar-map-btn {
    width:100%;padding:14px 16px;
    border-bottom:1px solid rgba(255,255,255,.06);
    font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.12em;
    display:flex;align-items:center;justify-content:space-between;
    background:transparent;border-left:none;border-right:none;border-top:none;
    color:#64748b;cursor:pointer;transition:all .2s;
  }
  .sidebar-map-btn.active { background:rgba(124,58,237,.13);color:#A78BFA; }
  .sidebar-nav { padding:8px; }
  .room-btn {
    width:100%;text-align:left;padding:11px 12px;border-radius:12px;
    border:1px solid transparent;background:transparent;
    cursor:pointer;display:flex;align-items:center;gap:10px;
    margin-bottom:4px;transition:all .15s;
  }
  .room-btn:hover { background:rgba(30,41,59,.5); }
  .room-btn.active { border-color:var(--room-color-55);background:var(--room-color-18); }
  .room-icon {
    width:36px;height:36px;border-radius:10px;
    display:flex;align-items:center;justify-content:center;
    font-size:16px;flex-shrink:0;transition:all .2s;
  }
  .room-icon.locked   { background:#1e1b4b;border:1px solid var(--room-color-44); }
  .room-icon.unlocked { background:#052e16;border:1px solid rgba(22,163,74,.35); }
  .room-label  { font-size:12px;font-weight:700;color:#e2e8f0; }
  .room-sublabel { font-size:11px;color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
  .now-badge {
    display:inline-block;margin-top:3px;padding:2px 8px;
    border-radius:99px;color:white;font-size:9px;font-weight:700;
  }
  .sidebar-clues { margin:8px;padding:12px;background:rgba(12,25,41,.7);border-radius:12px;border:1px solid rgba(30,58,95,.4); }
  .sidebar-clues-title { color:#60A5FA;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px; }
  .sidebar-clue-item { color:#7dd3fc;font-size:11px;line-height:1.5;margin-bottom:5px; }
  .sidebar-footer { padding:10px 16px 14px;border-top:1px solid rgba(255,255,255,.06);color:#334155;font-size:10px; }
  .sidebar-footer code { color:#7C3AED; }

  /* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card {
    background:#08091a;border-radius:20px;overflow:hidden;
    animation: fadeIn .3s ease;
  }
  .card-header {
    padding:24px 28px 20px;
    border-bottom:1px solid rgba(255,255,255,.05);
  }
  .card-header-inner { display:flex;align-items:flex-start;justify-content:space-between;gap:16px; }
  .card-title { font-size:18px;font-weight:800;letter-spacing:-.02em;color:#e2e8f0;line-height:1.2; }
  .card-subtitle { font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.1em;margin-top:2px; }
  .card-vibe { color:#64748b;font-size:12px;font-style:italic;margin-top:8px;display:flex;align-items:center;gap:8px; }
  .status-badge {
    padding:6px 14px;border-radius:99px;font-size:12px;font-weight:700;
    white-space:nowrap;flex-shrink:0;
  }
  .status-badge.locked   { background:#1e1b4b;border:1px solid var(--room-color-44);color:#94a3b8; }
  .status-badge.unlocked { background:#052e16;border:1px solid rgba(22,163,74,.35);color:#4ade80; }
  .card-body { padding:24px 28px;display:flex;flex-direction:column;gap:20px; }

  /* â”€â”€ STORY BOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .story-box {
    color:#cbd5e1;font-size:15px;line-height:1.7;
    padding:16px 20px;background:#0d0d1a;border-radius:12px;
    border-left:3px solid var(--room-color);
  }

  /* â”€â”€ ILLUSTRATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .illus-wrap {
    border-radius:16px;overflow:hidden;
    border:1px solid var(--room-color-33);
  }
  .illus-inner { background:linear-gradient(135deg,#050714,#0f0b1f); }
  .illus-inner svg { width:100%;height:170px;display:block; }
  .illus-caption {
    padding:8px 14px;background:#050714;
    border-top:1px solid var(--room-color-22);
    font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.1em;
    display:flex;align-items:center;gap:6px;
  }

  /* â”€â”€ CLUES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .clues-box { background:#0c1929;border:1px solid rgba(30,58,95,.35);border-radius:12px;overflow:hidden; }
  .clues-title { padding:12px 18px;border-bottom:1px solid rgba(30,58,95,.4);color:#60A5FA;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;display:flex;align-items:center;gap:8px; }
  .clues-grid { padding:14px 18px;display:grid;grid-template-columns:1fr 1fr;gap:10px; }
  @media(max-width:500px){ .clues-grid{grid-template-columns:1fr;} }
  .clue-item { padding:10px 14px;background:#0a1628;border-radius:10px;border:1px solid rgba(30,58,95,.35);color:#93c5fd;font-size:13px;line-height:1.5; }

  /* â”€â”€ TASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tasks-box { background:#08091a;border:1px solid var(--room-color-33);border-radius:14px;overflow:hidden; }
  .tasks-title { padding:14px 20px;background:var(--room-color-18);border-bottom:1px solid var(--room-color-22);color:#e2e8f0;font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px;text-transform:uppercase;letter-spacing:.08em; }
  .tasks-body { padding:16px 20px;display:flex;flex-direction:column;gap:12px; }
  .task-item { display:flex;align-items:flex-start;gap:12px; }
  .task-num {
    min-width:28px;height:28px;display:flex;align-items:center;justify-content:center;
    background:var(--room-color);border-radius:8px;color:white;font-size:13px;font-weight:800;flex-shrink:0;
  }
  .task-text { color:#cbd5e1;font-size:14px;line-height:1.6;padding-top:4px; }
  .task-note { margin-top:4px;padding:10px 14px;background:rgba(30,27,75,.35);border-radius:8px;color:#94a3b8;font-size:12px; }
  .task-note strong { color:#c4b5fd; }

  /* â”€â”€ CODE GATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .code-gate { display:flex;flex-direction:column;gap:12px; }
  .code-gate-info { padding:16px 20px;background:#0d0d1a;border:1px solid rgba(255,255,255,.08);border-radius:12px; }
  .code-gate-hint { color:#94a3b8;font-size:12px;margin-bottom:12px;display:flex;align-items:center;gap:8px; }
  .code-gate-row { display:flex;gap:10px;flex-wrap:wrap; }
  .code-input {
    flex:1;min-width:140px;background:#1e1b4b;
    border:2px solid var(--room-color-66);border-radius:10px;
    padding:12px 16px;color:#e2e8f0;font-size:22px;
    font-family:monospace;letter-spacing:.3em;text-align:center;outline:none;
    transition:border-color .2s;
  }
  .code-input:focus { border-color:var(--room-color); }
  .code-input.shake { animation:shake .5s ease; }
  .btn-unlock {
    border:none;border-radius:10px;padding:12px 20px;
    color:white;font-size:14px;font-weight:700;cursor:pointer;
    display:flex;align-items:center;gap:8px;
    background:var(--room-color-grad);
    box-shadow:0 4px 20px var(--room-color-44);
    transition:transform .1s;white-space:nowrap;
  }
  .btn-unlock:active { transform:scale(.97); }
  .code-msg { padding:12px 16px;border-radius:10px;font-size:14px;font-weight:500;animation:fadeIn .2s ease; }
  .code-msg.ok   { background:#052e16;border:1px solid rgba(22,163,74,.35);color:#4ade80; }
  .code-msg.err  { background:#1a0a0a;border:1px solid rgba(220,38,38,.35);color:#f87171; }
  .code-msg.warn { background:#1a1200;border:1px solid rgba(217,119,6,.35);color:#fbbf24; }
  .unlocked-msg { display:flex;align-items:center;gap:12px;padding:16px 20px;background:#052e16;border:1px solid rgba(22,163,74,.35);border-radius:12px;animation:fadeIn .3s ease; }
  .unlocked-msg-title { color:#4ade80;font-weight:700;font-size:14px; }
  .unlocked-msg-sub { color:#86efac;font-size:12px; }

  /* â”€â”€ NAV BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .nav-bar {
    margin-top:16px;background:rgba(8,9,26,.85);backdrop-filter:blur(20px);
    border:1px solid rgba(255,255,255,.07);border-radius:14px;
    padding:14px 20px;display:flex;align-items:center;
    justify-content:space-between;gap:16px;flex-wrap:wrap;
  }
  .nav-hint { color:#94a3b8;font-size:13px; }
  .nav-hint strong { color:#c4b5fd; }
  .nav-btns { display:flex;gap:10px; }
  .btn-nav {
    background:#1e293b;border:1px solid #334155;border-radius:10px;
    padding:10px 16px;color:#94a3b8;font-size:13px;font-weight:600;cursor:pointer;
    transition:all .15s;
  }
  .btn-nav:hover:not(:disabled) { color:#e2e8f0;border-color:#475569; }
  .btn-nav:disabled { color:#475569;cursor:not-allowed; }
  .btn-nav-primary {
    background:linear-gradient(135deg,#7C3AED,#6d28d9);border:none;
    border-radius:10px;padding:10px 16px;color:white;font-size:13px;font-weight:600;
    cursor:pointer;box-shadow:0 4px 16px rgba(124,58,237,.27);
  }

  /* â”€â”€ INTRO SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #intro {
    min-height:100vh;display:flex;align-items:center;justify-content:center;
    background:radial-gradient(ellipse at 30% 20%,#1e0a3c 0%,#050714 50%,#000 100%);
    padding:16px;
  }
  .intro-wrap { max-width:720px;width:100%;animation:fadeIn .5s ease; }
  .intro-card {
    background:rgba(8,9,26,.85);border:1px solid rgba(124,58,237,.27);
    border-radius:0 0 20px 20px;overflow:hidden;
  }
  .intro-warning {
    padding:10px 24px;background:#1a0a0a;border-bottom:1px solid rgba(127,29,29,.35);
    display:flex;align-items:center;gap:12px;color:#fca5a5;font-size:13px;font-weight:600;
  }
  .intro-warning span:first-child { animation:pulse 1s infinite; }
  .intro-body { padding:28px 32px; }
  .intro-badge {
    display:inline-flex;align-items:center;gap:8px;padding:6px 14px;
    background:#1e1b4b;border:1px solid rgba(67,56,202,.27);border-radius:99px;
    color:#a5b4fc;font-size:11px;font-weight:700;text-transform:uppercase;
    letter-spacing:.1em;margin-bottom:20px;
  }
  .intro-title { font-size:26px;font-weight:900;color:#f1f5f9;letter-spacing:-.03em;margin-bottom:14px;line-height:1.2; }
  .intro-story {
    color:#cbd5e1;font-size:15px;line-height:1.8;margin-bottom:20px;
    border-left:3px solid #7C3AED;padding-left:16px;
  }
  .intro-story strong { color:#a78bfa; }
  .clues-box-intro { background:#0d1117;border:1px solid rgba(30,58,95,.6);border-radius:14px;overflow:hidden;margin-bottom:24px; }
  .clues-box-intro-title { padding:12px 18px;background:#0c1929;border-bottom:1px solid rgba(30,58,95,.6);color:#60A5FA;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;display:flex;align-items:center;gap:8px; }
  .objectives-box { background:#0d0d1a;border:1px solid rgba(124,58,237,.2);border-radius:14px;overflow:hidden;margin-bottom:28px; }
  .objectives-title { padding:12px 18px;background:rgba(124,58,237,.13);border-bottom:1px solid rgba(124,58,237,.13);color:#c4b5fd;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.1em; }
  .objectives-body { padding:14px 18px;display:flex;flex-direction:column;gap:8px; }
  .obj-item { display:flex;align-items:flex-start;gap:10px; }
  .obj-num { min-width:22px;height:22px;background:#7C3AED;border-radius:6px;display:flex;align-items:center;justify-content:center;color:white;font-size:11px;font-weight:800;flex-shrink:0; }
  .obj-text { color:#cbd5e1;font-size:13px;padding-top:3px; }
  .btn-start {
    width:100%;background:linear-gradient(135deg,#7C3AED,#BE185D);border:none;
    border-radius:14px;padding:18px;color:white;font-size:17px;font-weight:800;
    cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;
    box-shadow:0 8px 32px rgba(124,58,237,.35);letter-spacing:-.01em;
    transition:transform .15s,box-shadow .15s;
  }
  .btn-start:hover { transform:translateY(-2px);box-shadow:0 12px 40px rgba(124,58,237,.45); }

  /* â”€â”€ MAP PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .map-panel { animation:fadeIn .3s ease; }
  .map-card { background:#08091a;border:1px solid rgba(124,58,237,.27);border-radius:20px;overflow:hidden;box-shadow:0 0 60px rgba(124,58,237,.1); }
  .map-header { padding:22px 28px 18px;background:linear-gradient(135deg,rgba(124,58,237,.13) 0%,transparent 60%);border-bottom:1px solid rgba(124,58,237,.13);display:flex;align-items:center;justify-content:space-between; }
  .map-title { color:#e2e8f0;font-size:18px;font-weight:800;letter-spacing:-.02em; }
  .map-subtitle { color:#A78BFA;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.1em;margin-top:3px; }
  .btn-close-map { background:#1e293b;border:1px solid #334155;border-radius:10px;padding:8px 14px;color:#94a3b8;font-size:13px;font-weight:600;cursor:pointer; }
  .map-body { padding:24px 28px;display:flex;flex-direction:column;gap:20px; }
  .map-story { color:#cbd5e1;font-size:14px;line-height:1.7;padding:14px 18px;background:#0d0d1a;border-radius:12px;border-left:3px solid #7C3AED; }
  .map-story strong { color:#a78bfa; }
  .map-svg-wrap { border-radius:16px;overflow:hidden;border:1px solid rgba(124,58,237,.2);background:linear-gradient(135deg,#050714,#0f0b1f); }

  /* â”€â”€ FINAL SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .final-card { background:#08091a;border:1px solid rgba(22,163,74,.35);border-radius:20px;overflow:hidden;box-shadow:0 0 80px rgba(22,163,74,.13);animation:fadeIn .4s ease; }
  .final-body { padding:40px 32px;text-align:center;background:linear-gradient(135deg,rgba(5,46,22,.27) 0%,transparent 60%); }
  .final-skull { font-size:64px;margin-bottom:16px;display:block;animation:float 3s ease-in-out infinite; }
  .final-title { color:#4ade80;font-size:28px;font-weight:900;letter-spacing:-.03em;margin-bottom:12px; }
  .final-text { color:#86efac;font-size:15px;line-height:1.7;max-width:520px;margin:0 auto 24px; }
  .final-note { display:inline-flex;align-items:flex-start;gap:10px;padding:16px 24px;background:#052e16;border:1px solid rgba(22,163,74,.35);border-radius:14px;color:#86efac;font-size:14px;margin-bottom:24px;text-align:left;max-width:480px; }
  .final-note strong { color:#4ade80; }
  .btn-restart { background:linear-gradient(135deg,#16a34a,#15803d);border:none;border-radius:12px;padding:14px 28px;color:white;font-size:15px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:10px;box-shadow:0 4px 20px rgba(22,163,74,.27); }

  /* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  footer { text-align:center;color:#1e293b;font-size:11px;margin-top:20px;padding-bottom:16px; }

  /* â”€â”€ SVG ANIMATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .flicker  { animation:flicker 1.5s ease-in-out infinite; }
  .flicker2 { animation:flicker 1.8s ease-in-out infinite .3s; }
  .pulse    { animation:pulse 2s ease-in-out infinite; }
  .float    { animation:float 2.5s ease-in-out infinite; }
  .float2   { animation:float 3s ease-in-out infinite .5s; }
  .float3   { animation:float 2.8s ease-in-out infinite 1s; }
  .shimmer  { animation:shimmer 3s ease-in-out infinite; }
  .drip     { animation:drip 2s ease-in-out infinite; }
  .blink    { animation:blink 2s ease-in-out infinite; }
  .blink2   { animation:blink 2.5s ease-in-out infinite .4s; }
  .blink3   { animation:blink 2.2s ease-in-out infinite .8s; }
  .dash     { animation:dash 1.5s linear infinite; }
  .dash2    { animation:dash 1.5s linear infinite .5s; }
  .dash3    { animation:dash 1.5s linear infinite 1s; }
  .hair1    { animation:float 2.5s ease-in-out infinite 0s; transform-origin:bottom center; }
  .hair2    { animation:float 2.8s ease-in-out infinite .3s; transform-origin:bottom center; }
  .hair3    { animation:float 2.3s ease-in-out infinite .6s; transform-origin:bottom center; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INTRO SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="intro">
  <div class="intro-wrap">

    <!-- Castle SVG -->
    <div style="margin-bottom:0;overflow:hidden;border-radius:20px 20px 0 0;">
      <svg viewBox="0 0 720 180" style="width:100%;height:150px;display:block;background:linear-gradient(135deg,#0b1020,#2a1240);">
        <!-- Glow -->
        <radialGradient id="ig" cx="50%" cy="30%" r="60%"><stop offset="0%" stop-color="#7C3AED" stop-opacity=".3"/><stop offset="100%" stop-color="#000" stop-opacity="0"/></radialGradient>
        <rect width="720" height="180" fill="url(#ig)"/>
        <!-- Stars -->
        <circle cx="30" cy="15" r="1.5" fill="#e2e8f0" opacity=".3" class="pulse"/>
        <circle cx="80" cy="28" r="1" fill="#e2e8f0" opacity=".2"/>
        <circle cx="140" cy="12" r="1.5" fill="#e2e8f0" opacity=".25" class="pulse"/>
        <circle cx="200" cy="30" r="1" fill="#e2e8f0" opacity=".2"/>
        <circle cx="260" cy="10" r="1" fill="#e2e8f0" opacity=".3" class="pulse"/>
        <circle cx="320" cy="25" r="1.5" fill="#e2e8f0" opacity=".2"/>
        <circle cx="390" cy="8" r="1" fill="#e2e8f0" opacity=".25"/>
        <circle cx="450" cy="22" r="1.5" fill="#e2e8f0" opacity=".3" class="pulse"/>
        <circle cx="520" cy="15" r="1" fill="#e2e8f0" opacity=".2"/>
        <circle cx="580" cy="30" r="1.5" fill="#e2e8f0" opacity=".25"/>
        <circle cx="650" cy="10" r="1" fill="#e2e8f0" opacity=".3" class="pulse"/>
        <circle cx="700" cy="25" r="1" fill="#e2e8f0" opacity=".2"/>
        <!-- Moon -->
        <circle cx="620" cy="42" r="34" fill="#1a0a2e" stroke="#A78BFA" stroke-width="1" stroke-opacity=".3"/>
        <circle cx="608" cy="35" r="29" fill="#050714"/>
        <!-- Castle -->
        <g opacity=".9">
          <rect x="280" y="55" width="160" height="125" fill="#070810"/>
          <rect x="285" y="43" width="14" height="15" rx="2" fill="#0a0b14"/>
          <rect x="305" y="49" width="14" height="10" rx="2" fill="#0a0b14"/>
          <rect x="325" y="43" width="14" height="15" rx="2" fill="#0a0b14"/>
          <rect x="345" y="49" width="14" height="10" rx="2" fill="#0a0b14"/>
          <rect x="365" y="43" width="14" height="15" rx="2" fill="#0a0b14"/>
          <rect x="385" y="49" width="14" height="10" rx="2" fill="#0a0b14"/>
          <rect x="405" y="43" width="14" height="15" rx="2" fill="#0a0b14"/>
          <rect x="200" y="72" width="90" height="108" fill="#080910"/>
          <rect x="205" y="62" width="10" height="14" rx="2" fill="#0a0b14"/>
          <rect x="222" y="67" width="10" height="10" rx="2" fill="#0a0b14"/>
          <rect x="239" y="62" width="10" height="14" rx="2" fill="#0a0b14"/>
          <rect x="256" y="67" width="10" height="10" rx="2" fill="#0a0b14"/>
          <rect x="430" y="72" width="90" height="108" fill="#080910"/>
          <rect x="435" y="62" width="10" height="14" rx="2" fill="#0a0b14"/>
          <rect x="452" y="67" width="10" height="10" rx="2" fill="#0a0b14"/>
          <rect x="469" y="62" width="14" height="14" rx="2" fill="#0a0b14"/>
          <rect x="490" y="67" width="10" height="10" rx="2" fill="#0a0b14"/>
          <rect x="100" y="92" width="65" height="88" fill="#060709"/>
          <rect x="555" y="92" width="65" height="88" fill="#060709"/>
          <!-- Glowing windows -->
          <rect x="308" y="92" width="10" height="14" rx="5" fill="#A78BFA" fill-opacity=".5" class="pulse"/>
          <rect x="330" y="92" width="10" height="14" rx="5" fill="#A78BFA" fill-opacity=".4"/>
          <rect x="352" y="92" width="10" height="14" rx="5" fill="#A78BFA" fill-opacity=".5" class="pulse"/>
          <rect x="374" y="92" width="10" height="14" rx="5" fill="#A78BFA" fill-opacity=".35"/>
          <rect x="396" y="92" width="10" height="14" rx="5" fill="#A78BFA" fill-opacity=".45" class="pulse"/>
          <rect x="218" y="92" width="10" height="14" rx="5" fill="#A78BFA" fill-opacity=".4"/>
          <rect x="458" y="92" width="10" height="14" rx="5" fill="#A78BFA" fill-opacity=".4"/>
          <rect x="113" y="108" width="10" height="14" rx="5" fill="#A78BFA" fill-opacity=".3" class="pulse"/>
          <rect x="567" y="108" width="10" height="14" rx="5" fill="#A78BFA" fill-opacity=".3"/>
          <!-- Gate -->
          <path d="M316 180 L316 148 Q360 125 404 148 L404 180Z" fill="#050714"/>
          <line x1="322" y1="180" x2="322" y2="148" stroke="#1e293b" stroke-width="3" stroke-opacity=".7"/>
          <line x1="340" y1="180" x2="340" y2="148" stroke="#1e293b" stroke-width="3" stroke-opacity=".7"/>
          <line x1="358" y1="180" x2="358" y2="148" stroke="#1e293b" stroke-width="3" stroke-opacity=".7"/>
          <line x1="376" y1="180" x2="376" y2="148" stroke="#1e293b" stroke-width="3" stroke-opacity=".7"/>
          <line x1="394" y1="180" x2="394" y2="148" stroke="#1e293b" stroke-width="3" stroke-opacity=".7"/>
        </g>
        <!-- Bats -->
        <g class="float" style="transform-origin:108px 40px">
          <path d="M100 40 Q92 32 86 36" stroke="#1e1b4b" stroke-width="2" fill="none"/>
          <path d="M100 40 Q108 32 114 36" stroke="#1e1b4b" stroke-width="2" fill="none"/>
          <circle cx="100" cy="40" r="3" fill="#0d0e1a"/>
        </g>
        <g class="float2" style="transform-origin:505px 35px">
          <path d="M497 35 Q489 27 483 31" stroke="#1e1b4b" stroke-width="2" fill="none"/>
          <path d="M497 35 Q505 27 511 31" stroke="#1e1b4b" stroke-width="2" fill="none"/>
          <circle cx="497" cy="35" r="3" fill="#0d0e1a"/>
        </g>
        <!-- Ground -->
        <path d="M0 175 C120 162,240 178,360 170 C480 162,600 178,720 168 L720 180 L0 180Z" fill="#050714"/>
        <!-- Title -->
        <text x="360" y="175" text-anchor="middle" fill="#A78BFA" font-size="11" fill-opacity=".6" letter-spacing="3" font-family="'Segoe UI',sans-serif">EL CASTELL DELS MORLEY</text>
      </svg>
    </div>

    <!-- Content -->
    <div class="intro-card">
      <div class="intro-warning">
        <span>âš ï¸</span>
        <span>No pots fer cap errada! Una sola errada i serÃ s un esclau dels Morley!</span>
      </div>
      <div class="intro-body">
        <div class="intro-badge">ğŸ”¬ FÃ­sica i QuÃ­mica Â· 2n d'ESO Â· SeparaciÃ³ de mescles</div>
        <h1 class="intro-title">Podreu escapar del castell?</h1>
        <p class="intro-story">
          Es fa fosc al castell dels Morleyâ€¦ Has caigut en mans dels maleÃ¯ts comtes Morley. No et deixen marxarâ€¦ si no escapes del castell <strong>abans de la mitjanit</strong>, romandrÃ s al seu castell per sempre mÃ©s i els servirÃ s la resta dels teus diesâ€¦<br><br>
          PerÃ², no tot estÃ  perdut! Si aconsegueixes superar les <strong style="color:#f472b6">quatre proves</strong> que et proposaran, serÃ s lliure! NomÃ©s hi ha una condiciÃ³â€¦ No pots fer cap errada!
        </p>

        <!-- Clues -->
        <div class="clues-box-intro">
          <div class="clues-box-intro-title">ğŸ’¡ Pistes que hauries de tenir en compte</div>
          <div class="clues-grid" style="padding:14px 18px;">
            <div class="clue-item">ğŸ”¬ L'alcohol bull a 78,4ÂºC</div>
            <div class="clue-item">ğŸ§‚ La sal Ã©s soluble en aigua i en alcohol</div>
            <div class="clue-item">ğŸ¬ El sucre Ã©s soluble en aigua perÃ² NO en alcohol</div>
            <div class="clue-item">ğŸŸ¡ El sofre NO Ã©s soluble en aigua</div>
          </div>
        </div>

        <!-- Objectives -->
        <div class="objectives-box">
          <div class="objectives-title">ğŸ¯ Objectius de l'activitat</div>
          <div class="objectives-body">
            <div class="obj-item"><div class="obj-num">1</div><div class="obj-text">ConÃ¨ixer les tÃ¨cniques de separaciÃ³ dels components de les mescles</div></div>
            <div class="obj-item"><div class="obj-num">2</div><div class="obj-text">Interpretar el concepte de solubilitat</div></div>
            <div class="obj-item"><div class="obj-num">3</div><div class="obj-text">ConÃ¨ixer l'instrumental de laboratori necessari</div></div>
            <div class="obj-item"><div class="obj-num">4</div><div class="obj-text">Dibuixar diagrames de separaciÃ³</div></div>
          </div>
        </div>

        <button class="btn-start" onclick="startGame()">
          âš”ï¸ Accepta el repte i entra al castell ğŸ°
        </button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN GAME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="game" style="display:none;">
  <div id="app">

    <!-- Top bar -->
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:14px;">
        <div class="topbar-logo">ğŸ°</div>
        <div>
          <div class="topbar-title">Escape Room Â· El Castell dels Morley</div>
          <div class="topbar-sub">FÃ­sica i QuÃ­mica Â· 2n d'ESO Â· SeparaciÃ³ de mescles</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
        <div class="progress-bar-wrap">
          <div class="progress-labels">
            <span>ProgrÃ©s</span>
            <span id="progress-text" style="color:#94a3b8;font-weight:600;">0/4 proves</span>
          </div>
          <div class="progress-track"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
        </div>
        <button class="btn-reset" onclick="resetGame()">ğŸ”„ Reinicia</button>
      </div>
    </div>

    <!-- Grid -->
    <div class="main-grid">

      <!-- Sidebar -->
      <div class="sidebar">
        <button class="sidebar-map-btn" id="map-btn" onclick="toggleMap()">
          <span>ğŸ—ºï¸ Mapa del Castell</span>
          <span id="map-arrow">â–¼</span>
        </button>
        <div class="sidebar-nav" id="sidebar-nav"></div>
        <div class="sidebar-clues">
          <div class="sidebar-clues-title">ğŸ’¡ Pistes generals</div>
          <div class="sidebar-clue-item">ğŸ”¬ L'alcohol bull a 78,4ÂºC</div>
          <div class="sidebar-clue-item">ğŸ§‚ La sal Ã©s soluble en aigua i en alcohol</div>
          <div class="sidebar-clue-item">ğŸ¬ El sucre Ã©s soluble en aigua perÃ² NO en alcohol</div>
          <div class="sidebar-clue-item">ğŸŸ¡ El sofre NO Ã©s soluble en aigua</div>
        </div>
        <div class="sidebar-footer">Codis gestionats per l'objecte <code>CODES</code> al codi font.</div>
      </div>

      <!-- Main content -->
      <div id="main-content"></div>

    </div>
    <footer>INS Santiago SobrequÃ©s i Vidal Â· FÃ­sica i QuÃ­mica 2n ESO Â· ProgrÃ©s guardat al navegador</footer>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE_KEY = 'escape_morley_html_v1';
const CODES = { 1:'70831', 2:'19467', 3:'56290', 4:'83914' };

const ROOMS = [
  {
    id:1, emoji:'ğŸ¥ƒ', color:'#7C3AED', glow:'#A78BFA',
    title:'Sal al whisky!', subtitle:'HabitaciÃ³ 1',
    character:'Nan Johnny Morley', charEmoji:'ğŸ‘º',
    vibe:"El nan Johnny t'assenyala amb el dit tremolÃ³sâ€¦",
    story:"Han dissolt sal dins de la bota de whisky del nan Johnny Morley! En Johnny et demana que aconsegueixis separar l'alcohol del whisky i la sal de la beguda. La sal Ã©s la clau per passar a la segona prova, perÃ² l'alcohol l'haurÃ s de guardar i portar-lo a sobre per si el necessites mÃ©s endavantâ€¦",
    tasks:["Quines tÃ¨cniques de separaciÃ³ utilitzaries per donar-li al Johnny el que necessita?","Fes els diagrames de separaciÃ³ a la llibreta.","Enumera els estris de laboratori que utilitzaries."],
    clueIds:[0,1],
  },
  {
    id:2, emoji:'ğŸ”ï¸', color:'#B45309', glow:'#FCD34D',
    title:'Sorra DolÃ§a', subtitle:'HabitaciÃ³ 2',
    character:'Gegant McLeod', charEmoji:'ğŸ‘¹',
    vibe:"El gegant McLeod t'agafa amb la mÃ  i t'apropa al seu rostreâ€¦",
    story:"Has entrat al dormitori del gegant McLeod i estÃ  enfurismat! AlgÃº li ha posat sucre i pedres a la seva sorra de platja i aquesta nit no podrÃ  fer les glopades de sorra fina que tant li agraden. Diu que si no l'ajudes et farÃ  rentar el lavabo del seu dormitoriâ€¦ i ja et puc assegurar que els lavabos dels gegants no sÃ³n precisament nets.",
    tasks:["Com elimines el sucre de la barreja de sucre, sorra i pedres?","Fes els diagrames de separaciÃ³ a la llibreta.","Enumera els estris de laboratori que utilitzaries."],
    clueIds:[2],
  },
  {
    id:3, emoji:'ğŸ§', color:'#0F766E', glow:'#34D399',
    title:"La Ferida de l'Elf Lasgole", subtitle:'HabitaciÃ³ 3',
    character:'Elf Lasgole', charEmoji:'ğŸ§',
    vibe:"L'elf Lasgole t'apunta amb el seu arcâ€¦",
    story:"EstÃ s molt a prop de la sortida del castell. L'elf Lasgole s'ha fet una ferida a la mÃ  i et demana que l'ajudis a desinfectar-la amb iode, perÃ² els follets li han barrejat el iode amb sal i sorra. Si no aconsegueixes ajudar-lo, et farÃ  servir de diana a les seves prÃ ctiques de tir amb arc. Pista: no oblidis el que has anat recollint a les altres provesâ€¦",
    tasks:["Com separes el iode de la sal i la sorra?","Fes els diagrames de separaciÃ³ a la llibreta.","Enumera els estris de laboratori que faries servir."],
    clueIds:[0,1,2,3],
  },
  {
    id:4, emoji:'ğŸ”®', color:'#BE185D', glow:'#F9A8D4',
    title:'La Porta de les Tres Claus', subtitle:'HabitaciÃ³ 4',
    character:'Els follets Isi, Ya i Va', charEmoji:'ğŸ‘»',
    vibe:"Tres ulls brillants t'observen des de la foscor del llac Isiyavaâ€¦",
    story:"Has arribat a la darrera habitaciÃ³. Els follets Isi, Ya i Va tenen les tres claus de la porta final. El follet Isi et donarÃ  la seva clau si li dones sal per la seva sopa. El follet Ya la seva si li dones sucre per al seu cafÃ¨. El follet Va la seva si li dones sofre per preparar el foc valiry que destruirÃ  el castell. Et presenten una barreja de sal, sucre i sofre.",
    tasks:["Com separes la sal, el sucre i el sofre de la mescla?","Fes el diagrama de separaciÃ³ complet a la llibreta.","Enumera tot l'instrumental necessari."],
    clueIds:[0,1,2,3],
  }
];

const CLUES = [
  "ğŸ”¬ L'alcohol bull a 78,4ÂºC",
  "ğŸ§‚ La sal Ã©s soluble en aigua i en alcohol",
  "ğŸ¬ El sucre Ã©s soluble en aigua perÃ² NO en alcohol",
  "ğŸŸ¡ El sofre NO Ã©s soluble en aigua"
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = { current:1, unlocked:{1:false,2:false,3:false,4:false}, showMap:false };

function loadState() {
  try { const s = localStorage.getItem(STORAGE_KEY); if(s) return JSON.parse(s); } catch{}
  return null;
}
function saveState() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify({current:state.current, unlocked:state.unlocked})); } catch{}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ILLUSTRATIONS (inline SVG strings)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function svgRoom1(color) {
  return `<svg viewBox="0 0 900 220" style="width:100%;height:170px;display:block;">
  <defs>
    <radialGradient id="r1bg" cx="55%" cy="40%" r="55%"><stop offset="0%" stop-color="${color}" stop-opacity=".15"/><stop offset="100%" stop-color="#000" stop-opacity="0"/></radialGradient>
    <linearGradient id="r1bar" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="#3d2008"/><stop offset="50%" stop-color="#5c3a1e"/><stop offset="100%" stop-color="#3d2008"/></linearGradient>
    <linearGradient id="r1liq" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#b45309" stop-opacity=".85"/><stop offset="100%" stop-color="#78350f" stop-opacity=".95"/></linearGradient>
  </defs>
  <rect x="0" y="0" width="900" height="220" fill="url(#r1bg)"/>
  <!-- stars -->
  <circle cx="60"  cy="14" r="1.5" fill="#e2e8f0" opacity=".16"/>
  <circle cx="130" cy="30" r="1"   fill="#e2e8f0" opacity=".14"/>
  <circle cx="210" cy="12" r="1.5" fill="#e2e8f0" opacity=".16"/>
  <circle cx="300" cy="26" r="1"   fill="#e2e8f0" opacity=".12"/>
  <circle cx="420" cy="18" r="1.5" fill="#e2e8f0" opacity=".16" class="pulse"/>
  <circle cx="510" cy="8"  r="1"   fill="#e2e8f0" opacity=".14"/>
  <circle cx="600" cy="22" r="1.5" fill="#e2e8f0" opacity=".12"/>
  <circle cx="680" cy="10" r="1"   fill="#e2e8f0" opacity=".16" class="pulse"/>
  <circle cx="770" cy="28" r="1.5" fill="#e2e8f0" opacity=".14"/>
  <circle cx="850" cy="16" r="1"   fill="#e2e8f0" opacity=".12"/>
  <!-- wall -->
  <path d="M0 130 L0 80 L40 80 L40 65 L65 65 L65 80 L110 80 L110 60 L135 42 L160 60 L160 80 L230 80 L230 65 L255 65 L255 80 L900 80 L900 220 L0 220Z" fill="#0a0b14"/>
  <!-- candle 1 -->
  <rect x="768" y="108" width="10" height="22" rx="2" fill="#d4a96a" fill-opacity=".7"/>
  <path d="M773 108 Q770 100 773 94 Q776 100 773 108" fill="#fbbf24" fill-opacity=".9" class="flicker"/>
  <ellipse cx="773" cy="102" rx="12" ry="8" fill="#fbbf24" fill-opacity=".06" class="shimmer"/>
  <!-- candle 2 -->
  <rect x="118" y="108" width="10" height="18" rx="2" fill="#d4a96a" fill-opacity=".6"/>
  <path d="M123 108 Q120 101 123 95 Q126 101 123 108" fill="#fbbf24" fill-opacity=".8" class="flicker2"/>
  <!-- big barrel -->
  <g transform="translate(380,62)">
    <ellipse cx="70" cy="22" rx="70" ry="18" fill="#3d2008"/>
    <rect x="0" y="22" width="140" height="118" fill="url(#r1bar)" rx="5"/>
    <ellipse cx="70" cy="140" rx="70" ry="18" fill="#3d2008"/>
    <rect x="0" y="38" width="140" height="7" rx="3" fill="#2a1505" opacity=".8"/>
    <rect x="0" y="72" width="140" height="7" rx="3" fill="#2a1505" opacity=".8"/>
    <rect x="0" y="106" width="140" height="7" rx="3" fill="#2a1505" opacity=".8"/>
    <ellipse cx="70" cy="22" rx="56" ry="11" fill="url(#r1liq)" opacity=".8"/>
    <ellipse cx="55" cy="18" rx="25" ry="5" fill="#fbbf24" fill-opacity=".12" class="shimmer"/>
    <rect x="55" y="118" width="30" height="12" rx="5" fill="#6b5010"/>
    <rect x="81" y="121" width="18" height="6" rx="3" fill="#78350f"/>
    <circle cx="99" cy="130" r="4" fill="${color}" fill-opacity=".5" class="drip"/>
    <text x="70" y="170" text-anchor="middle" fill="#92400e" font-size="13" font-weight="700" fill-opacity=".8" font-family="'Segoe UI',sans-serif">whisky del Johnny</text>
  </g>
  <!-- small barrel left -->
  <g transform="translate(280,110)">
    <ellipse cx="35" cy="12" rx="35" ry="10" fill="#2a1505"/>
    <rect x="0" y="12" width="70" height="75" fill="#3d2008" rx="3"/>
    <ellipse cx="35" cy="87" rx="35" ry="10" fill="#2a1505"/>
    <rect x="0" y="25" width="70" height="5" rx="2" fill="#1a0f03" opacity=".7"/>
    <rect x="0" y="48" width="70" height="5" rx="2" fill="#1a0f03" opacity=".7"/>
    <rect x="0" y="70" width="70" height="5" rx="2" fill="#1a0f03" opacity=".7"/>
  </g>
  <!-- barrel tipped -->
  <g transform="translate(640,130) rotate(-20)">
    <ellipse cx="30" cy="10" rx="30" ry="9" fill="#2a1505"/>
    <rect x="0" y="10" width="60" height="62" fill="#3d2008" rx="3"/>
    <ellipse cx="30" cy="72" rx="30" ry="9" fill="#2a1505"/>
    <rect x="0" y="22" width="60" height="4" rx="2" fill="#1a0f03" opacity=".7"/>
    <rect x="0" y="42" width="60" height="4" rx="2" fill="#1a0f03" opacity=".7"/>
    <rect x="0" y="62" width="60" height="4" rx="2" fill="#1a0f03" opacity=".7"/>
  </g>
  <!-- puddle -->
  <ellipse cx="680" cy="195" rx="55" ry="12" fill="#b45309" fill-opacity=".35" class="shimmer"/>
  <!-- dwarf -->
  <g transform="translate(150,72)" opacity=".92">
    <rect x="20" y="115" width="22" height="40" rx="8" fill="#0d0e1a"/>
    <rect x="52" y="115" width="22" height="40" rx="8" fill="#0d0e1a"/>
    <ellipse cx="47" cy="100" rx="38" ry="42" fill="#0d0e1a"/>
    <path d="M18 75 Q47 105 76 75 Q72 130 47 135 Q22 130 18 75Z" fill="#12102a" opacity=".85"/>
    <circle cx="47" cy="52" r="32" fill="#0d0e1a"/>
    <ellipse cx="47" cy="60" rx="10" ry="8" fill="#0f0e1f"/>
    <ellipse cx="34" cy="44" rx="7" ry="8" fill="${color}" fill-opacity=".95"/>
    <ellipse cx="60" cy="44" rx="7" ry="8" fill="${color}" fill-opacity=".95"/>
    <circle cx="34" cy="44" r="3" fill="#000"/>
    <circle cx="60" cy="44" r="3" fill="#000"/>
    <path d="M26 37 L42 42" stroke="#e2e8f0" stroke-width="3" stroke-linecap="round" stroke-opacity=".6"/>
    <path d="M52 42 L68 37" stroke="#e2e8f0" stroke-width="3" stroke-linecap="round" stroke-opacity=".6"/>
    <path d="M20 32 L47 -15 L74 32Z" fill="#0a0b14"/>
    <rect x="14" y="29" width="66" height="9" rx="4" fill="#12102a"/>
    <rect x="40" y="31" width="14" height="6" rx="2" fill="${color}" fill-opacity=".4"/>
    <path d="M85 80 Q115 55 130 40" stroke="#0d0e1a" stroke-width="16" stroke-linecap="round" fill="none"/>
    <ellipse cx="133" cy="36" rx="14" ry="12" fill="#0d0e1a"/>
    <!-- speech bubble -->
    <rect x="125" y="-20" width="80" height="36" rx="10" fill="#12102a" stroke="${color}" stroke-width="1.5" stroke-opacity=".5"/>
    <path d="M140 16 L130 30 L153 16Z" fill="#12102a"/>
    <text x="165" y="-6" text-anchor="middle" fill="${color}" font-size="10" font-weight="700" fill-opacity=".9" font-family="'Segoe UI',sans-serif">On Ã©s</text>
    <text x="165" y="8" text-anchor="middle" fill="${color}" font-size="10" font-weight="700" fill-opacity=".9" font-family="'Segoe UI',sans-serif">el meu whisky?!</text>
  </g>
  <!-- salt bag -->
  <g transform="translate(580,155)">
    <path d="M0 0 Q5 -40 30 -42 Q55 -40 60 0 Q50 15 30 15 Q10 15 0 0Z" fill="#1e293b" stroke="#475569" stroke-width="1.5" stroke-opacity=".5"/>
    <text x="30" y="-18" text-anchor="middle" fill="white" font-size="11" fill-opacity=".5" font-family="'Segoe UI',sans-serif">SAL</text>
  </g>
</svg>`;
}

function svgRoom2(color) {
  return `<svg viewBox="0 0 900 220" style="width:100%;height:170px;display:block;">
  <defs>
    <radialGradient id="r2bg" cx="65%" cy="35%" r="55%"><stop offset="0%" stop-color="${color}" stop-opacity=".16"/><stop offset="100%" stop-color="#000" stop-opacity="0"/></radialGradient>
  </defs>
  <rect x="0" y="0" width="900" height="220" fill="url(#r2bg)"/>
  <!-- stars -->
  <circle cx="50"  cy="12" r="1.5" fill="#e2e8f0" opacity=".15" class="pulse"/>
  <circle cx="130" cy="25" r="1"   fill="#e2e8f0" opacity=".13"/>
  <circle cx="220" cy="10" r="1.5" fill="#e2e8f0" opacity=".15"/>
  <circle cx="310" cy="22" r="1"   fill="#e2e8f0" opacity=".13" class="pulse"/>
  <circle cx="400" cy="14" r="1"   fill="#e2e8f0" opacity=".15"/>
  <circle cx="490" cy="28" r="1.5" fill="#e2e8f0" opacity=".13"/>
  <circle cx="580" cy="8"  r="1"   fill="#e2e8f0" opacity=".15" class="pulse"/>
  <circle cx="670" cy="20" r="1.5" fill="#e2e8f0" opacity=".13"/>
  <circle cx="760" cy="12" r="1"   fill="#e2e8f0" opacity=".15"/>
  <circle cx="850" cy="26" r="1.5" fill="#e2e8f0" opacity=".13"/>
  <!-- ceiling -->
  <rect x="0" y="0" width="900" height="90" fill="#07080e"/>
  <rect x="0" y="88" width="900" height="4" fill="#0d0e1a"/>
  <!-- chains -->
  <ellipse cx="120" cy="10"  rx="4" ry="6" fill="none" stroke="#334155" stroke-width="1.5" stroke-opacity=".5"/>
  <ellipse cx="120" cy="28"  rx="4" ry="6" fill="none" stroke="#334155" stroke-width="1.5" stroke-opacity=".5"/>
  <ellipse cx="120" cy="46"  rx="4" ry="6" fill="none" stroke="#334155" stroke-width="1.5" stroke-opacity=".5"/>
  <ellipse cx="120" cy="64"  rx="4" ry="6" fill="none" stroke="#334155" stroke-width="1.5" stroke-opacity=".5"/>
  <ellipse cx="200" cy="10"  rx="4" ry="6" fill="none" stroke="#334155" stroke-width="1.5" stroke-opacity=".5"/>
  <ellipse cx="200" cy="28"  rx="4" ry="6" fill="none" stroke="#334155" stroke-width="1.5" stroke-opacity=".5"/>
  <ellipse cx="200" cy="46"  rx="4" ry="6" fill="none" stroke="#334155" stroke-width="1.5" stroke-opacity=".5"/>
  <!-- torch -->
  <rect x="348" y="55" width="12" height="30" rx="3" fill="#44240a" fill-opacity=".8"/>
  <path d="M354 55 Q350 43 354 33 Q358 43 354 55" fill="#f97316" fill-opacity=".9" class="flicker"/>
  <ellipse cx="354" cy="44" rx="14" ry="10" fill="#f97316" fill-opacity=".06" class="shimmer"/>
  <rect x="558" y="55" width="12" height="30" rx="3" fill="#44240a" fill-opacity=".8"/>
  <path d="M564 55 Q560 43 564 33 Q568 43 564 55" fill="#f97316" fill-opacity=".8" class="flicker2"/>
  <!-- floor -->
  <rect x="0" y="155" width="900" height="65" fill="#1c1107"/>
  <!-- bed -->
  <g transform="translate(560,110)">
    <rect x="0" y="0" width="310" height="50" rx="8" fill="#1c0f06" stroke="#2d1a0a" stroke-width="2"/>
    <rect x="20"  y="5" width="25" height="38" rx="4" fill="#251208" opacity=".8"/>
    <rect x="60"  y="5" width="25" height="38" rx="4" fill="#251208" opacity=".8"/>
    <rect x="100" y="5" width="25" height="38" rx="4" fill="#251208" opacity=".8"/>
    <rect x="140" y="5" width="25" height="38" rx="4" fill="#251208" opacity=".8"/>
    <rect x="180" y="5" width="25" height="38" rx="4" fill="#251208" opacity=".8"/>
    <rect x="220" y="5" width="25" height="38" rx="4" fill="#251208" opacity=".8"/>
    <rect x="260" y="5" width="25" height="38" rx="4" fill="#251208" opacity=".8"/>
    <rect x="0" y="48" width="310" height="90" rx="4" fill="#180e05"/>
    <rect x="5" y="48" width="300" height="80" rx="6" fill="#1e1410" stroke="#2d2010" stroke-width="1"/>
    <rect x="15" y="52" width="80" height="45" rx="10" fill="#2a1e12" stroke="#3d2e1a" stroke-width="1"/>
  </g>
  <!-- sand pile -->
  <g transform="translate(250,125)">
    <path d="M0 90 Q80 30 200 45 Q310 28 370 90Z" fill="#92400e" fill-opacity=".7"/>
    <path d="M20 90 Q90 45 180 52 Q280 40 350 90Z" fill="#b45309" fill-opacity=".5"/>
    <ellipse cx="30"  cy="75" rx="16" ry="6" fill="white" fill-opacity=".2"/>
    <ellipse cx="75"  cy="67" rx="16" ry="6" fill="white" fill-opacity=".2"/>
    <ellipse cx="120" cy="72" rx="16" ry="6" fill="white" fill-opacity=".2"/>
    <ellipse cx="165" cy="64" rx="16" ry="6" fill="white" fill-opacity=".2"/>
    <ellipse cx="220" cy="70" rx="16" ry="6" fill="white" fill-opacity=".2"/>
    <ellipse cx="280" cy="66" rx="16" ry="6" fill="white" fill-opacity=".2"/>
    <ellipse cx="50"  cy="78" rx="18" ry="10" fill="#334155" stroke="#475569" stroke-width="1" stroke-opacity=".5"/>
    <ellipse cx="110" cy="80" rx="22" ry="11" fill="#334155" stroke="#475569" stroke-width="1" stroke-opacity=".5"/>
    <ellipse cx="170" cy="76" rx="18" ry="10" fill="#334155" stroke="#475569" stroke-width="1" stroke-opacity=".5"/>
    <ellipse cx="240" cy="80" rx="20" ry="10" fill="#334155" stroke="#475569" stroke-width="1" stroke-opacity=".5"/>
    <ellipse cx="305" cy="76" rx="16" ry="9"  fill="#334155" stroke="#475569" stroke-width="1" stroke-opacity=".5"/>
    <text x="185" y="108" text-anchor="middle" fill="#f59e0b" font-size="13" font-weight="700" fill-opacity=".8" font-family="'Segoe UI',sans-serif">Sorra + sucre + pedres</text>
  </g>
  <!-- giant -->
  <g transform="translate(30,10)" opacity=".92">
    <rect x="30" y="160" width="36" height="55" rx="12" fill="#0d0e1a"/>
    <rect x="80" y="160" width="36" height="55" rx="12" fill="#0d0e1a"/>
    <ellipse cx="73" cy="140" rx="58" ry="70" fill="#0d0e1a"/>
    <circle cx="73" cy="60" r="52" fill="#0d0e1a"/>
    <!-- wild hair -->
    <path d="M33 14 Q25 -5 28 -15" stroke="#0f0e1f" stroke-width="8" fill="none" stroke-linecap="round" class="hair1"/>
    <path d="M47 10 Q42 -8 45 -18" stroke="#0f0e1f" stroke-width="8" fill="none" stroke-linecap="round" class="hair2"/>
    <path d="M60 8 Q58 -10 61 -20" stroke="#0f0e1f" stroke-width="8" fill="none" stroke-linecap="round" class="hair3"/>
    <path d="M73 7 Q73 -12 73 -22" stroke="#0f0e1f" stroke-width="8" fill="none" stroke-linecap="round" class="hair1"/>
    <path d="M86 8 Q88 -10 85 -20" stroke="#0f0e1f" stroke-width="8" fill="none" stroke-linecap="round" class="hair2"/>
    <path d="M99 10 Q104 -8 101 -18" stroke="#0f0e1f" stroke-width="8" fill="none" stroke-linecap="round" class="hair3"/>
    <path d="M113 14 Q121 -5 118 -15" stroke="#0f0e1f" stroke-width="8" fill="none" stroke-linecap="round" class="hair1"/>
    <!-- angry eyes -->
    <path d="M44 48 Q58 40 72 48" stroke="${color}" stroke-width="3.5" fill="none"/>
    <path d="M74 48 Q88 40 102 48" stroke="${color}" stroke-width="3.5" fill="none"/>
    <ellipse cx="58" cy="56" rx="9" ry="10" fill="${color}" fill-opacity=".85"/>
    <ellipse cx="88" cy="56" rx="9" ry="10" fill="${color}" fill-opacity=".85"/>
    <circle cx="58" cy="56" r="4" fill="#000"/>
    <circle cx="88" cy="56" r="4" fill="#000"/>
    <ellipse cx="73" cy="72" rx="12" ry="9" fill="#0f0e1f" opacity=".8"/>
    <path d="M52 88 Q73 80 94 88" fill="none" stroke="#e2e8f0" stroke-width="2" stroke-opacity=".3"/>
    <path d="M131 110 Q175 130 230 150" stroke="#0d0e1a" stroke-width="22" stroke-linecap="round" fill="none"/>
    <ellipse cx="235" cy="153" rx="18" ry="15" fill="#0d0e1a"/>
    <!-- speech bubble -->
    <rect x="135" y="-30" width="110" height="42" rx="12" fill="#0f0e1f" stroke="${color}" stroke-width="1.5" stroke-opacity=".5"/>
    <path d="M150 12 L140 28 L168 12Z" fill="#0f0e1f"/>
    <text x="190" y="-14" text-anchor="middle" fill="${color}" font-size="11" font-weight="700" font-family="'Segoe UI',sans-serif">M'han embruixat</text>
    <text x="190" y="0"  text-anchor="middle" fill="${color}" font-size="11" font-weight="700" font-family="'Segoe UI',sans-serif">la sorra!!!</text>
  </g>
</svg>`;
}

function svgRoom3(color) {
  return `<svg viewBox="0 0 900 220" style="width:100%;height:170px;display:block;">
  <defs>
    <radialGradient id="r3bg" cx="40%" cy="30%" r="55%"><stop offset="0%" stop-color="${color}" stop-opacity=".2"/><stop offset="100%" stop-color="#000" stop-opacity="0"/></radialGradient>
  </defs>
  <rect x="0" y="0" width="900" height="220" fill="url(#r3bg)"/>
  <!-- moon -->
  <circle cx="750" cy="50" r="42" fill="#071a10" stroke="${color}" stroke-width="1" stroke-opacity=".3"/>
  <circle cx="738" cy="42" r="36" fill="#030e08"/>
  <!-- trees -->
  <path d="M0 220 L0 100 L28 55 L56 100 L56 220Z" fill="#040a06" opacity=".85"/>
  <path d="M55 220 L55 110 L83 65 L111 110 L111 220Z" fill="#040a06" opacity=".85"/>
  <path d="M105 220 L105 120 L133 75 L161 120 L161 220Z" fill="#040a06" opacity=".85"/>
  <path d="M155 220 L155 115 L183 70 L211 115 L211 220Z" fill="#040a06" opacity=".85"/>
  <path d="M580 220 L580 100 L608 55 L636 100 L636 220Z" fill="#040a06" opacity=".85"/>
  <path d="M635 220 L635 110 L663 65 L691 110 L691 220Z" fill="#040a06" opacity=".85"/>
  <path d="M690 220 L690 120 L718 75 L746 120 L746 220Z" fill="#040a06" opacity=".85"/>
  <path d="M745 220 L745 115 L773 70 L801 115 L801 220Z" fill="#040a06" opacity=".85"/>
  <path d="M800 220 L800 105 L828 58 L856 105 L856 220Z" fill="#040a06" opacity=".85"/>
  <!-- ground -->
  <path d="M0 185 C150 172,300 192,450 180 C600 168,750 188,900 178 L900 220 L0 220Z" fill="#050f07"/>
  <!-- broken vial -->
  <g transform="translate(380,130)">
    <path d="M20 0 L15 60 Q15 80 35 80 Q55 80 55 60 L50 0Z" fill="none" stroke="${color}" stroke-width="2" stroke-opacity=".6"/>
    <path d="M25 0 L35 -15 L45 0" fill="none" stroke="${color}" stroke-width="2" stroke-opacity=".5"/>
    <path d="M15 60 Q15 80 35 80 Q55 80 55 60 L50 40 L20 40Z" fill="${color}" fill-opacity=".3"/>
    <ellipse cx="35" cy="85" rx="40" ry="10" fill="${color}" fill-opacity=".25" class="shimmer"/>
    <text x="35" y="105" text-anchor="middle" fill="${color}" font-size="12" font-weight="700" fill-opacity=".8" font-family="'Segoe UI',sans-serif">iode + sal + sorra</text>
    <path d="M15 50 L5 55" stroke="${color}" stroke-width="1.5" stroke-opacity=".4"/>
    <path d="M50 45 L60 55" stroke="${color}" stroke-width="1.5" stroke-opacity=".4"/>
  </g>
  <!-- goblin 1 (scattering) -->
  <g transform="translate(480,120)">
    <ellipse cx="25" cy="55" rx="18" ry="22" fill="#0a1a0c"/>
    <circle  cx="25" cy="30" r="18" fill="#0a1a0c"/>
    <path d="M8 28 L-8 18 L8 38Z" fill="#0a1a0c"/>
    <path d="M42 28 L58 18 L42 38Z" fill="#0a1a0c"/>
    <circle cx="18" cy="26" r="6" fill="${color}" fill-opacity=".9"/>
    <circle cx="32" cy="26" r="6" fill="${color}" fill-opacity=".9"/>
    <circle cx="18" cy="26" r="2.5" fill="#000"/>
    <circle cx="32" cy="26" r="2.5" fill="#000"/>
    <path d="M15 40 Q25 48 35 40" fill="none" stroke="#e2e8f0" stroke-width="1.5" stroke-opacity=".4"/>
    <path d="M43 45 Q62 30 78 22" stroke="#0a1a0c" stroke-width="8" stroke-linecap="round" fill="none"/>
    <circle cx="82" cy="15" r="3" fill="${color}" fill-opacity=".6" class="float"/>
    <circle cx="92" cy="7"  r="3" fill="${color}" fill-opacity=".5" class="float2"/>
    <circle cx="100" cy="18" r="3" fill="${color}" fill-opacity=".6" class="float3"/>
  </g>
  <!-- goblin 2 (mirror) -->
  <g transform="translate(320,120) scale(-1,1) translate(-50,0)">
    <ellipse cx="25" cy="55" rx="18" ry="22" fill="#0a1a0c"/>
    <circle  cx="25" cy="30" r="18" fill="#0a1a0c"/>
    <path d="M8 28 L-8 18 L8 38Z" fill="#0a1a0c"/>
    <path d="M42 28 L58 18 L42 38Z" fill="#0a1a0c"/>
    <circle cx="18" cy="26" r="6" fill="${color}" fill-opacity=".9"/>
    <circle cx="32" cy="26" r="6" fill="${color}" fill-opacity=".9"/>
    <circle cx="18" cy="26" r="2.5" fill="#000"/>
    <circle cx="32" cy="26" r="2.5" fill="#000"/>
    <path d="M43 45 Q62 30 78 22" stroke="#0a1a0c" stroke-width="8" stroke-linecap="round" fill="none"/>
    <circle cx="82" cy="15" r="3" fill="${color}" fill-opacity=".6" class="float2"/>
    <circle cx="92" cy="7"  r="3" fill="${color}" fill-opacity=".5" class="float3"/>
  </g>
  <!-- elf Lasgole -->
  <g transform="translate(100,20)" opacity=".92">
    <path d="M30 220 L30 150 Q30 135 50 130 Q70 125 70 140 L70 220Z" fill="#0a120b"/>
    <circle cx="50" cy="98" r="30" fill="#0a120b"/>
    <path d="M22 92 L-4 72 L22 108Z" fill="#0a120b"/>
    <path d="M78 92 L104 72 L78 108Z" fill="#0a120b"/>
    <path d="M22 92 Q5 130 10 175"  stroke="#0d160e" stroke-width="12" fill="none" stroke-linecap="round"/>
    <path d="M78 92 Q95 130 90 175" stroke="#0d160e" stroke-width="12" fill="none" stroke-linecap="round"/>
    <path d="M28 80 Q50 68 72 80" fill="none" stroke="${color}" stroke-width="2.5" stroke-opacity=".6"/>
    <circle cx="28" cy="80" r="2.5" fill="${color}" fill-opacity=".5"/>
    <circle cx="40" cy="74" r="2.5" fill="${color}" fill-opacity=".5"/>
    <circle cx="50" cy="70" r="2.5" fill="${color}" fill-opacity=".5"/>
    <circle cx="60" cy="74" r="2.5" fill="${color}" fill-opacity=".5"/>
    <circle cx="72" cy="80" r="2.5" fill="${color}" fill-opacity=".5"/>
    <ellipse cx="40" cy="96" rx="7" ry="9" fill="${color}" fill-opacity=".9"/>
    <ellipse cx="60" cy="96" rx="7" ry="9" fill="${color}" fill-opacity=".9"/>
    <ellipse cx="40" cy="96" rx="3" ry="4" fill="#000"/>
    <ellipse cx="60" cy="96" rx="3" ry="4" fill="#000"/>
    <path d="M38 112 Q50 108 62 112" fill="none" stroke="#e2e8f0" stroke-width="1.5" stroke-opacity=".35"/>
    <path d="M70 145 Q100 135 120 125" stroke="#0a120b" stroke-width="14" stroke-linecap="round" fill="none"/>
    <circle cx="122" cy="123" r="12" fill="none" stroke="#f1f5f9" stroke-width="2" stroke-opacity=".4" stroke-dasharray="4,3"/>
    <path d="M118 130 Q115 140 118 146 Q122 140 118 130" fill="#ef4444" fill-opacity=".75" class="pulse"/>
    <path d="M70 160 Q30 140 30 110"  fill="none" stroke="#5c3a1e" stroke-width="3.5" stroke-opacity=".7"/>
    <path d="M70 160 Q110 140 105 110" fill="none" stroke="#5c3a1e" stroke-width="3.5" stroke-opacity=".7"/>
    <line x1="30" y1="110" x2="105" y2="110" stroke="#94a3b8" stroke-width="1.5" stroke-opacity=".5"/>
    <g class="float">
      <line x1="105" y1="110" x2="160" y2="100" stroke="#94a3b8" stroke-width="2" stroke-opacity=".6"/>
      <polygon points="160,96 172,100 160,104" fill="#94a3b8" fill-opacity=".7"/>
    </g>
  </g>
  <!-- fireflies -->
  <circle cx="650" cy="140" r="2.5" fill="${color}" fill-opacity=".5" class="blink"/>
  <circle cx="700" cy="152" r="2.5" fill="${color}" fill-opacity=".5" class="blink2"/>
  <circle cx="750" cy="142" r="2.5" fill="${color}" fill-opacity=".5" class="blink3"/>
  <circle cx="800" cy="155" r="2.5" fill="${color}" fill-opacity=".5" class="blink"/>
  <circle cx="820" cy="140" r="2.5" fill="${color}" fill-opacity=".5" class="blink2"/>
</svg>`;
}

function svgRoom4(color) {
  const gc = ['#60A5FA','#FCD34D','#86EFAC'];
  const gn = ['Isi','Ya','Va'];
  const gi = ['ğŸ§‚','ğŸ¬','ğŸŸ¡'];
  let goblins = '';
  for(let i=0;i<3;i++){
    const x = 120 + i*220;
    goblins += `<g transform="translate(${x},45)">
      <ellipse cx="32" cy="115" rx="40" ry="12" fill="${gc[i]}" fill-opacity=".06" class="shimmer"/>
      <ellipse cx="32" cy="90" rx="22" ry="32" fill="#0a0a18"/>
      <path d="M10 90 Q32 115 54 90 L54 120 Q32 145 10 120Z" fill="#08080f" opacity=".9"/>
      <circle cx="32" cy="50" r="26" fill="#0a0a18"/>
      <path d="M8 46 L-10 32 L8 60Z" fill="#0a0a18"/>
      <path d="M56 46 L74 32 L56 60Z" fill="#0a0a18"/>
      <path d="M10 34 L32 -8 L54 34Z" fill="#080810"/>
      <rect x="5" y="31" width="54" height="8" rx="3" fill="#0d0d1c"/>
      <rect x="7" y="33" width="50" height="4" rx="2" fill="${gc[i]}" fill-opacity=".4"/>
      <circle cx="22" cy="48" r="8" fill="${gc[i]}" fill-opacity=".9"/>
      <circle cx="42" cy="48" r="8" fill="${gc[i]}" fill-opacity=".9"/>
      <circle cx="22" cy="48" r="3.5" fill="#000"/>
      <circle cx="42" cy="48" r="3.5" fill="#000"/>
      <path d="M20 64 Q32 72 44 64" fill="none" stroke="#e2e8f0" stroke-width="1.5" stroke-opacity=".3"/>
      <g class="float${i===0?'':i===1?'2':'3'}">
        <path d="M32 -18 Q20 -18 20 -26 Q20 -34 32 -34 Q44 -34 44 -26 Q44 -18 32 -18Z" fill="none" stroke="${gc[i]}" stroke-width="2.5" stroke-opacity=".85"/>
        <rect x="38" y="-20" width="22" height="6" rx="2" fill="${gc[i]}" fill-opacity=".75"/>
        <rect x="54" y="-20" width="4" height="12" rx="1" fill="${gc[i]}" fill-opacity=".75"/>
        <rect x="47" y="-14" width="4" height="8" rx="1" fill="${gc[i]}" fill-opacity=".75"/>
      </g>
      <text x="32" y="155" text-anchor="middle" fill="${gc[i]}" font-size="13" font-weight="800" fill-opacity=".95" font-family="'Segoe UI',sans-serif">${gn[i]}</text>
      <text x="32" y="172" text-anchor="middle" font-size="16" font-family="'Segoe UI',sans-serif">${gi[i]}</text>
    </g>`;
  }
  return `<svg viewBox="0 0 900 220" style="width:100%;height:170px;display:block;">
  <defs>
    <radialGradient id="r4bg" cx="50%" cy="25%" r="60%"><stop offset="0%" stop-color="${color}" stop-opacity=".18"/><stop offset="100%" stop-color="#000" stop-opacity="0"/></radialGradient>
  </defs>
  <rect x="0" y="0" width="900" height="220" fill="url(#r4bg)"/>
  <!-- moon -->
  <circle cx="450" cy="50" r="50" fill="#100822" stroke="${color}" stroke-width="1" stroke-opacity=".25"/>
  <circle cx="438" cy="42" r="44" fill="#050714"/>
  <!-- stars -->
  <circle cx="40"  cy="8"  r="2"   fill="#e2e8f0" fill-opacity=".2" class="pulse"/>
  <circle cx="100" cy="20" r="1.2" fill="#e2e8f0" fill-opacity=".2"/>
  <circle cx="170" cy="10" r="1.5" fill="#e2e8f0" fill-opacity=".2" class="pulse"/>
  <circle cx="240" cy="24" r="1.2" fill="#e2e8f0" fill-opacity=".2"/>
  <circle cx="320" cy="8"  r="1.5" fill="#e2e8f0" fill-opacity=".2" class="pulse"/>
  <circle cx="530" cy="12" r="1.5" fill="#e2e8f0" fill-opacity=".2"/>
  <circle cx="610" cy="26" r="1.2" fill="#e2e8f0" fill-opacity=".2" class="pulse"/>
  <circle cx="680" cy="8"  r="1.5" fill="#e2e8f0" fill-opacity=".2"/>
  <circle cx="760" cy="20" r="1.2" fill="#e2e8f0" fill-opacity=".2" class="pulse"/>
  <circle cx="840" cy="10" r="1.5" fill="#e2e8f0" fill-opacity=".2"/>
  <!-- shore -->
  <path d="M0 145 C120 130,280 152,450 140 C620 128,780 150,900 138 L900 220 L0 220Z" fill="#080910" opacity=".9"/>
  <!-- lake -->
  <path d="M50 165 C180 148,360 170,540 158 C700 146,820 170,900 160 L900 220 L50 220Z" fill="#12092a" fill-opacity=".95"/>
  <!-- goblin eye reflections -->
  <ellipse cx="200" cy="190" rx="18" ry="5" fill="#60A5FA" fill-opacity=".12" class="shimmer"/>
  <ellipse cx="400" cy="190" rx="18" ry="5" fill="#FCD34D" fill-opacity=".12" class="shimmer"/>
  <ellipse cx="600" cy="190" rx="18" ry="5" fill="#86EFAC" fill-opacity=".12" class="shimmer"/>
  <!-- three goblins -->
  ${goblins}
  <!-- door -->
  <g transform="translate(790,25)" opacity=".9">
    <path d="M0 195 L0 60 Q0 10 50 5 Q100 10 100 60 L100 195Z" fill="#06060f" stroke="#ffffff" stroke-width="1.5" stroke-opacity=".12"/>
    <rect x="8"  y="70" width="38" height="55" rx="3" fill="#0a0a1c" stroke="#ffffff" stroke-width=".8" stroke-opacity=".1"/>
    <rect x="54" y="70" width="38" height="55" rx="3" fill="#0a0a1c" stroke="#ffffff" stroke-width=".8" stroke-opacity=".1"/>
    <rect x="8"  y="133" width="84" height="55" rx="3" fill="#0a0a1c" stroke="#ffffff" stroke-width=".8" stroke-opacity=".1"/>
    <circle cx="29" cy="88" r="7" fill="none" stroke="#60A5FA" stroke-width="1.8" stroke-opacity=".7"/>
    <rect x="25" y="95" width="8" height="9" rx="1.5" fill="none" stroke="#60A5FA" stroke-width="1.8" stroke-opacity=".7"/>
    <circle cx="50" cy="95" r="7" fill="none" stroke="#FCD34D" stroke-width="1.8" stroke-opacity=".7"/>
    <rect x="46" y="102" width="8" height="9" rx="1.5" fill="none" stroke="#FCD34D" stroke-width="1.8" stroke-opacity=".7"/>
    <circle cx="71" cy="88" r="7" fill="none" stroke="#86EFAC" stroke-width="1.8" stroke-opacity=".7"/>
    <rect x="67" y="95" width="8" height="9" rx="1.5" fill="none" stroke="#86EFAC" stroke-width="1.8" stroke-opacity=".7"/>
    <circle cx="15" cy="148" r="6" fill="${color}" fill-opacity=".4"/>
    <path d="M2 60 Q50 8 98 60" fill="none" stroke="${color}" stroke-width="2" stroke-opacity=".2" class="pulse"/>
  </g>
  <text x="450" y="215" text-anchor="middle" fill="${color}" font-size="12" font-weight="600" fill-opacity=".5" letter-spacing="3" font-family="'Segoe UI',sans-serif">LLAC ISIYAVA</text>
</svg>`;
}

const SVGS = [null, svgRoom1, svgRoom2, svgRoom3, svgRoom4];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP SVG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMapSVG() {
  const u = state.unlocked;
  return `<svg viewBox="0 0 900 340" style="width:100%;display:block;">
  <defs>
    <radialGradient id="mglow" cx="50%" cy="40%" r="55%"><stop offset="0%" stop-color="#7C3AED" stop-opacity=".12"/><stop offset="100%" stop-color="#000" stop-opacity="0"/></radialGradient>
  </defs>
  <rect x="0" y="0" width="900" height="340" fill="url(#mglow)"/>
  <circle cx="40"  cy="8"  r="1.8" fill="#e2e8f0" opacity=".15" class="pulse"/>
  <circle cx="90"  cy="20" r="1.2" fill="#e2e8f0" opacity=".15"/>
  <circle cx="160" cy="9"  r="1.5" fill="#e2e8f0" opacity=".15" class="pulse"/>
  <circle cx="230" cy="22" r="1.2" fill="#e2e8f0" opacity=".15"/>
  <circle cx="300" cy="7"  r="1.5" fill="#e2e8f0" opacity=".15"/>
  <circle cx="370" cy="18" r="1.2" fill="#e2e8f0" opacity=".15" class="pulse"/>
  <circle cx="440" cy="8"  r="1.5" fill="#e2e8f0" opacity=".15"/>
  <circle cx="510" cy="22" r="1.2" fill="#e2e8f0" opacity=".15" class="pulse"/>
  <circle cx="580" cy="10" r="1.5" fill="#e2e8f0" opacity=".15"/>
  <circle cx="650" cy="20" r="1.2" fill="#e2e8f0" opacity=".15"/>
  <circle cx="720" cy="8"  r="1.5" fill="#e2e8f0" opacity=".15" class="pulse"/>
  <circle cx="790" cy="18" r="1.2" fill="#e2e8f0" opacity=".15"/>
  <circle cx="860" cy="9"  r="1.5" fill="#e2e8f0" opacity=".15"/>
  <!-- outer walls -->
  <rect x="40" y="50" width="820" height="240" rx="8" fill="none" stroke="#334155" stroke-width="2" stroke-opacity=".5" stroke-dasharray="8,6"/>
  <!-- Room 1 -->
  <rect x="60" y="90" width="190" height="160" rx="6" fill="#7C3AED18" stroke="#7C3AED" stroke-width="2" stroke-opacity="${u[1]?.0.9:0.4}"/>
  <rect x="60" y="90" width="190" height="35" rx="6" fill="#7C3AED33"/>
  <text x="155" y="113" text-anchor="middle" fill="#A78BFA" font-size="12" font-weight="800" font-family="'Segoe UI',sans-serif">HabitaciÃ³ 1</text>
  <text x="155" y="128" text-anchor="middle" fill="#A78BFA" font-size="9" fill-opacity=".7" font-family="'Segoe UI',sans-serif">Celler del Nan Johnny</text>
  <g transform="translate(90,155)"><ellipse cx="12" cy="5" rx="12" ry="5" fill="#5c3a1e" fill-opacity=".7"/><rect x="0" y="5" width="24" height="30" rx="2" fill="#3d2008" fill-opacity=".7"/><ellipse cx="12" cy="35" rx="12" ry="5" fill="#5c3a1e" fill-opacity=".7"/></g>
  <g transform="translate(130,155)"><ellipse cx="12" cy="5" rx="12" ry="5" fill="#5c3a1e" fill-opacity=".7"/><rect x="0" y="5" width="24" height="30" rx="2" fill="#3d2008" fill-opacity=".7"/><ellipse cx="12" cy="35" rx="12" ry="5" fill="#5c3a1e" fill-opacity=".7"/></g>
  <g transform="translate(170,155)"><ellipse cx="12" cy="5" rx="12" ry="5" fill="#5c3a1e" fill-opacity=".7"/><rect x="0" y="5" width="24" height="30" rx="2" fill="#3d2008" fill-opacity=".7"/><ellipse cx="12" cy="35" rx="12" ry="5" fill="#5c3a1e" fill-opacity=".7"/></g>
  <text x="155" y="238" text-anchor="middle" font-size="16" font-family="'Segoe UI',sans-serif">${u[1]?'âœ…':'ğŸ”’'}</text>
  <!-- Corridor 1â†’2 -->
  <rect x="250" y="140" width="80" height="30" rx="4" fill="#1e293b" fill-opacity=".5"/>
  <path d="M268 155 L312 155" stroke="#7C3AED" stroke-width="2" stroke-dasharray="5,4" class="dash"/>
  <polygon points="312,151 322,155 312,159" fill="#7C3AED" fill-opacity=".7"/>
  <!-- Room 2 -->
  <rect x="290" y="55" width="200" height="155" rx="6" fill="#B4530918" stroke="#B45309" stroke-width="2" stroke-opacity="${u[2]?0.9:0.4}"/>
  <rect x="290" y="55" width="200" height="35" rx="6" fill="#B4530933"/>
  <text x="390" y="78" text-anchor="middle" fill="#FCD34D" font-size="12" font-weight="800" font-family="'Segoe UI',sans-serif">HabitaciÃ³ 2</text>
  <text x="390" y="93" text-anchor="middle" fill="#FCD34D" font-size="9" fill-opacity=".7" font-family="'Segoe UI',sans-serif">Dormitori del Gegant</text>
  <rect x="310" y="105" width="160" height="90" rx="6" fill="#180e05" fill-opacity=".8"/>
  <rect x="310" y="105" width="160" height="25" rx="6" fill="#1c0f06" fill-opacity=".9"/>
  <rect x="315" y="109" width="20" height="18" rx="3" fill="#251208" fill-opacity=".8"/>
  <rect x="345" y="109" width="20" height="18" rx="3" fill="#251208" fill-opacity=".8"/>
  <rect x="375" y="109" width="20" height="18" rx="3" fill="#251208" fill-opacity=".8"/>
  <rect x="405" y="109" width="20" height="18" rx="3" fill="#251208" fill-opacity=".8"/>
  <rect x="435" y="109" width="20" height="18" rx="3" fill="#251208" fill-opacity=".8"/>
  <rect x="315" y="128" width="70" height="55" rx="5" fill="#2a1e12" fill-opacity=".7"/>
  <text x="390" y="200" text-anchor="middle" font-size="16" font-family="'Segoe UI',sans-serif">${u[2]?'âœ…':'ğŸ”’'}</text>
  <!-- Corridor 2â†’3 -->
  <rect x="490" y="100" width="80" height="30" rx="4" fill="#1e293b" fill-opacity=".5"/>
  <path d="M508 115 L552 115" stroke="#B45309" stroke-width="2" stroke-dasharray="5,4" class="dash2"/>
  <polygon points="552,111 562,115 552,119" fill="#B45309" fill-opacity=".7"/>
  <!-- Room 3 -->
  <rect x="530" y="70" width="190" height="175" rx="6" fill="#0F766E18" stroke="#0F766E" stroke-width="2" stroke-opacity="${u[3]?0.9:0.4}"/>
  <rect x="530" y="70" width="190" height="35" rx="6" fill="#0F766E33"/>
  <text x="625" y="93" text-anchor="middle" fill="#34D399" font-size="12" font-weight="800" font-family="'Segoe UI',sans-serif">HabitaciÃ³ 3</text>
  <text x="625" y="108" text-anchor="middle" fill="#34D399" font-size="9" fill-opacity=".7" font-family="'Segoe UI',sans-serif">Bosc de l'Elf Lasgole</text>
  <path d="M555 190 L570 145 L585 190Z" fill="#040a06" fill-opacity=".8"/>
  <path d="M600 190 L615 142 L630 190Z" fill="#040a06" fill-opacity=".8"/>
  <path d="M645 190 L660 148 L675 190Z" fill="#040a06" fill-opacity=".8"/>
  <path d="M690 190 L705 143 L720 190Z" fill="#040a06" fill-opacity=".8"/>
  <text x="625" y="232" text-anchor="middle" font-size="16" font-family="'Segoe UI',sans-serif">${u[3]?'âœ…':'ğŸ”’'}</text>
  <!-- Corridor 3â†’4 -->
  <rect x="695" y="190" width="30" height="70" rx="4" fill="#1e293b" fill-opacity=".5"/>
  <path d="M710 208 L710 248" stroke="#0F766E" stroke-width="2" stroke-dasharray="5,4" class="dash3"/>
  <polygon points="706,248 710,258 714,248" fill="#0F766E" fill-opacity=".7"/>
  <!-- Room 4 -->
  <rect x="560" y="235" width="290" height="90" rx="6" fill="#BE185D18" stroke="#BE185D" stroke-width="2" stroke-opacity="${u[4]?0.9:0.4}"/>
  <rect x="560" y="235" width="290" height="30" rx="6" fill="#BE185D33"/>
  <text x="705" y="256" text-anchor="middle" fill="#F9A8D4" font-size="12" font-weight="800" font-family="'Segoe UI',sans-serif">HabitaciÃ³ 4</text>
  <text x="705" y="270" text-anchor="middle" fill="#F9A8D4" font-size="9" fill-opacity=".7" font-family="'Segoe UI',sans-serif">Llac dels Follets Isiyava</text>
  <path d="M575 285 C620 275,680 292,750 282 C800 275,830 290,840 282 L840 318 L575 318Z" fill="#12092a" fill-opacity=".8"/>
  <circle cx="620" cy="300" r="4" fill="#60A5FA" fill-opacity=".8" class="blink"/>
  <circle cx="690" cy="300" r="4" fill="#FCD34D" fill-opacity=".8" class="blink2"/>
  <circle cx="760" cy="300" r="4" fill="#86EFAC" fill-opacity=".8" class="blink3"/>
  <text x="705" y="320" text-anchor="middle" font-size="16" font-family="'Segoe UI',sans-serif">${u[4]?'âœ…':'ğŸ”’'}</text>
  <!-- Entry -->
  <g transform="translate(40,235)">
    <rect x="0" y="0" width="50" height="55" rx="4" fill="#07080f" stroke="#475569" stroke-width="1.5" stroke-opacity=".5"/>
    <path d="M0 30 Q25 10 50 30" fill="#07080f" stroke="#475569" stroke-width="1.5" stroke-opacity=".4"/>
    <text x="25" y="48" text-anchor="middle" fill="#64748b" font-size="9" font-family="'Segoe UI',sans-serif">Entrada</text>
    <path d="M50 28 L66 28" stroke="#7C3AED" stroke-width="2" class="pulse"/>
    <polygon points="58,24 66,28 58,32" fill="#7C3AED" fill-opacity=".8"/>
  </g>
  <!-- Legend -->
  <circle cx="63" cy="318" r="6" fill="#4ade80" fill-opacity=".3" stroke="#4ade80" stroke-width="1.5"/>
  <text x="75" y="322" fill="#4ade80" font-size="10" fill-opacity=".7" font-family="'Segoe UI',sans-serif">Superada</text>
  <circle cx="150" cy="318" r="6" fill="none" stroke="#64748b" stroke-width="1.5" stroke-dasharray="2,2"/>
  <text x="162" y="322" fill="#64748b" font-size="10" font-family="'Segoe UI',sans-serif">Tancada</text>
  <path d="M225 318 L250 318" stroke="#7C3AED" stroke-width="2" stroke-dasharray="5,4" class="dash"/>
  <text x="255" y="322" fill="#94a3b8" font-size="10" font-family="'Segoe UI',sans-serif">PassadÃ­s</text>
</svg>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hex2rgba(hex, a) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}

function setCSSVars(el, color) {
  el.style.setProperty('--room-color', color);
  el.style.setProperty('--room-color-18', hex2rgba(color, 0.18));
  el.style.setProperty('--room-color-22', hex2rgba(color, 0.22));
  el.style.setProperty('--room-color-33', hex2rgba(color, 0.33));
  el.style.setProperty('--room-color-44', hex2rgba(color, 0.44));
  el.style.setProperty('--room-color-55', hex2rgba(color, 0.55));
  el.style.setProperty('--room-color-66', hex2rgba(color, 0.66));
  el.style.setProperty('--room-color-grad', `linear-gradient(135deg,${color},${color}cc)`);
}

function unlockedCount() {
  return [1,2,3,4].filter(i => state.unlocked[i]).length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSidebar() {
  const nav = document.getElementById('sidebar-nav');
  nav.innerHTML = '';
  ROOMS.forEach(room => {
    const isActive = !state.showMap && state.current === room.id;
    const isUnlocked = state.unlocked[room.id];
    const btn = document.createElement('button');
    btn.className = 'room-btn' + (isActive ? ' active' : '');
    if (isActive) setCSSVars(btn, room.color);
    btn.style.setProperty('--room-color-55', hex2rgba(room.color, 0.55));
    btn.style.setProperty('--room-color-18', hex2rgba(room.color, 0.18));
    btn.innerHTML = `
      <div class="room-icon ${isUnlocked?'unlocked':'locked'}" style="--room-color-44:${hex2rgba(room.color,.44)}">
        ${isUnlocked ? 'âœ…' : room.emoji}
      </div>
      <div style="min-width:0">
        <div class="room-label">Prova ${room.id}</div>
        <div class="room-sublabel">${room.title}</div>
        ${isActive ? `<div class="now-badge" style="background:${room.color}">ARA</div>` : ''}
      </div>`;
    btn.addEventListener('click', () => { state.showMap = false; state.current = room.id; render(); });
    nav.appendChild(btn);
  });

  const mapBtn = document.getElementById('map-btn');
  mapBtn.className = 'sidebar-map-btn' + (state.showMap ? ' active' : '');
  document.getElementById('map-arrow').textContent = state.showMap ? 'â–²' : 'â–¼';
}

function renderProgress() {
  const c = unlockedCount();
  document.getElementById('progress-text').textContent = c + '/4 proves';
  document.getElementById('progress-fill').style.width = (c/4*100) + '%';
}

function renderMain() {
  const main = document.getElementById('main-content');
  main.innerHTML = '';

  if (state.showMap) {
    main.appendChild(renderMapPanel());
    return;
  }

  if (unlockedCount() === 4) {
    main.appendChild(renderFinal());
    return;
  }

  const room = ROOMS.find(r => r.id === state.current) || ROOMS[0];
  main.appendChild(renderRoom(room));

  // nav bar
  const nav = document.createElement('div');
  nav.className = 'nav-bar';
  nav.innerHTML = `
    <div class="nav-hint"><strong>Recordeu:</strong> escriviu el procediment pas a pas i justifiqueu per quÃ¨ la tÃ¨cnica funciona.</div>
    <div class="nav-btns">
      <button class="btn-nav" ${state.current===1?'disabled':''} onclick="goRoom(${state.current-1})">â† Anterior</button>
      <button class="${state.current===4?'btn-nav':'btn-nav-primary'}" ${state.current===4?'disabled':''} onclick="goRoom(${state.current+1})">SegÃ¼ent â†’</button>
    </div>`;
  main.appendChild(nav);
}

function renderRoom(room) {
  const isUnlocked = state.unlocked[room.id];
  const clueIds = room.clueIds;

  const div = document.createElement('div');
  div.className = 'card';
  div.style.border = `1px solid ${hex2rgba(room.color, .27)}`;
  div.style.boxShadow = `0 0 60px ${hex2rgba(room.color, .1)}`;
  setCSSVars(div, room.color);

  // Build clues HTML
  let cluesHTML = '';
  if (clueIds.length) {
    cluesHTML = `<div class="clues-box">
      <div class="clues-title">ğŸ’¡ Pistes rellevants per aquesta prova</div>
      <div style="padding:14px 18px;display:flex;flex-direction:column;gap:6px;">
        ${clueIds.map(id => `<div style="color:#93c5fd;font-size:13px;padding:6px 10px;background:#0a1628;border-radius:8px;">${CLUES[id]}</div>`).join('')}
      </div>
    </div>`;
  }

  // Code gate
  let codeGateHTML = '';
  if (isUnlocked) {
    codeGateHTML = `<div class="unlocked-msg">
      <span style="font-size:24px">âœ…</span>
      <div>
        <div class="unlocked-msg-title">Prova superada!</div>
        <div class="unlocked-msg-sub">Porta desbloquejada â€” podeu avanÃ§ar</div>
      </div>
    </div>`;
  } else {
    codeGateHTML = `<div class="code-gate">
      <div class="code-gate-info">
        <div class="code-gate-hint">ğŸ” El/la professorÂ·a us donarÃ  el codi quan validi la vostra resposta a la llibreta</div>
        <div class="code-gate-row">
          <input class="code-input" id="code-${room.id}" type="text" inputmode="numeric" maxlength="5" placeholder="Â· Â· Â· Â· Â·" onkeydown="if(event.key==='Enter')tryUnlock(${room.id})"/>
          <button class="btn-unlock" onclick="tryUnlock(${room.id})">ğŸšª Desbloqueja</button>
        </div>
      </div>
      <div id="code-msg-${room.id}" style="display:none"></div>
    </div>`;
  }

  div.innerHTML = `
    <div class="card-header" style="background:linear-gradient(135deg,${hex2rgba(room.color,.13)} 0%,transparent 60%);border-bottom:1px solid ${hex2rgba(room.color,.13)};">
      <div class="card-header-inner">
        <div>
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px;">
            <span style="font-size:28px">${room.emoji}</span>
            <div>
              <div class="card-title">${room.title}</div>
              <div class="card-subtitle" style="color:${room.glow}">${room.subtitle}</div>
            </div>
          </div>
          <div class="card-vibe">
            <span>${room.charEmoji}</span>
            <span style="color:#475569">Â·</span>
            <span>${room.vibe}</span>
          </div>
        </div>
        <div class="status-badge ${isUnlocked?'unlocked':'locked'}" style="--room-color-44:${hex2rgba(room.color,.44)}">
          ${isUnlocked ? 'âœ… Superada' : 'ğŸ”’ Tancada'}
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="story-box">${room.story}</div>
      <div class="illus-wrap" style="--room-color:${room.color};--room-color-33:${hex2rgba(room.color,.33)};--room-color-22:${hex2rgba(room.color,.22)};">
        <div class="illus-inner">${SVGS[room.id](room.color)}</div>
        <div class="illus-caption" style="color:${room.glow}">âœ¨ IlÂ·lustraciÃ³ ambiental Â· ${room.subtitle}</div>
      </div>
      ${cluesHTML}
      <div class="tasks-box" style="--room-color:${room.color};--room-color-18:${hex2rgba(room.color,.18)};--room-color-22:${hex2rgba(room.color,.22)};--room-color-33:${hex2rgba(room.color,.33)};">
        <div class="tasks-title">ğŸ“‹ QuÃ¨ has de fer a la llibreta</div>
        <div class="tasks-body">
          ${room.tasks.map((t,i) => `<div class="task-item">
            <div class="task-num" style="background:${room.color}">${i+1}</div>
            <div class="task-text">${t}</div>
          </div>`).join('')}
          <div class="task-note"><strong>Recorda:</strong> justifica per quÃ¨ la tÃ¨cnica escollida funciona i quin instrumental de laboratori Ã©s necessari.</div>
        </div>
      </div>
      ${codeGateHTML}
    </div>`;
  return div;
}

function renderMapPanel() {
  const div = document.createElement('div');
  div.className = 'map-panel';
  div.innerHTML = `<div class="map-card">
    <div class="map-header">
      <div>
        <div class="map-title">ğŸ—ºï¸ Mapa del Castell dels Morley</div>
        <div class="map-subtitle">OrientaciÃ³ Â· Les 4 habitacions</div>
      </div>
      <button class="btn-close-map" onclick="toggleMap()">âœ• Tanca</button>
    </div>
    <div class="map-body">
      <div class="map-story">
        Es fa fosc al castell dels Morleyâ€¦ Has caigut en mans dels maleÃ¯ts comtes Morley. Si no escapes del castell <strong>abans de la mitjanit</strong>, romandrÃ s al seu castell per sempre mÃ©s. Supera les <strong style="color:#f472b6">quatre proves</strong> i serÃ s lliure!
      </div>
      <div class="map-svg-wrap">${renderMapSVG()}</div>
      <div class="clues-box">
        <div class="clues-title">ğŸ’¡ Pistes que cal tenir en compte</div>
        <div class="clues-grid">
          <div class="clue-item">ğŸ”¬ L'alcohol bull a 78,4ÂºC</div>
          <div class="clue-item">ğŸ§‚ La sal Ã©s soluble en aigua i en alcohol</div>
          <div class="clue-item">ğŸ¬ El sucre Ã©s soluble en aigua perÃ² NO en alcohol</div>
          <div class="clue-item">ğŸŸ¡ El sofre NO Ã©s soluble en aigua</div>
        </div>
      </div>
    </div>
  </div>`;
  return div;
}

function renderFinal() {
  const div = document.createElement('div');
  div.innerHTML = `<div class="final-card">
    <div class="final-body">
      <span class="final-skull">ğŸ’€</span>
      <h2 class="final-title">Heu escapat del castell dels Morley!</h2>
      <p class="final-text">Felicitats! Heu superat les 4 proves de separaciÃ³ de mescles. Ara toca revisar amb el/la professorÂ·a el raonament, els diagrames i l'instrumental de laboratori de cadascuna.</p>
      <div class="final-note"><span style="font-size:20px;flex-shrink:0">ğŸ¯</span><span>L'objectiu Ã©s explicar bÃ© el <strong>raonament</strong>: quina tÃ¨cnica uses, per quÃ¨ funciona per a cada component i quin instrumental cal per dur-la a terme.</span></div>
      <br/>
      <button class="btn-restart" onclick="resetGame()">ğŸ”„ Tornar a comenÃ§ar</button>
    </div>
  </div>`;
  return div;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MASTER RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  renderSidebar();
  renderProgress();
  renderMain();
  saveState();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame() {
  document.getElementById('intro').style.display = 'none';
  document.getElementById('game').style.display = 'block';
  render();
}

function toggleMap() {
  state.showMap = !state.showMap;
  render();
}

function goRoom(id) {
  id = Math.max(1, Math.min(4, id));
  state.current = id;
  state.showMap = false;
  render();
}

function tryUnlock(roomId) {
  const input = document.getElementById('code-' + roomId);
  const msgEl = document.getElementById('code-msg-' + roomId);
  const val = input.value.replace(/\D/g,'');

  // remove shake
  input.classList.remove('shake');
  void input.offsetWidth; // reflow

  if (val.length !== 5) {
    input.classList.add('shake');
    msgEl.style.display = 'block';
    msgEl.className = 'code-msg warn';
    msgEl.textContent = 'âš ï¸ El codi ha de tenir exactament 5 xifres.';
    return;
  }
  if (val === CODES[roomId]) {
    msgEl.style.display = 'block';
    msgEl.className = 'code-msg ok';
    msgEl.textContent = 'âœ… Codi correcte! Obrint la portaâ€¦';
    setTimeout(() => {
      state.unlocked[roomId] = true;
      const next = Math.min(4, roomId + 1);
      if (!state.unlocked[next]) state.current = next;
      render();
    }, 600);
  } else {
    input.classList.add('shake');
    msgEl.style.display = 'block';
    msgEl.className = 'code-msg err';
    msgEl.textContent = 'âŒ Codi incorrecte. Torneu-ho a provar.';
  }
}

function resetGame() {
  state = { current:1, unlocked:{1:false,2:false,3:false,4:false}, showMap:false };
  try { localStorage.removeItem(STORAGE_KEY); } catch{}
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init() {
  const saved = loadState();
  if (saved) {
    if (saved.current)  state.current  = Math.max(1, Math.min(4, Number(saved.current)));
    if (saved.unlocked) state.unlocked = {
      1:!!saved.unlocked[1], 2:!!saved.unlocked[2],
      3:!!saved.unlocked[3], 4:!!saved.unlocked[4]
    };
  }
  // If previously started, skip intro
  if (saved && (saved.unlocked?.[1] || saved.current > 1)) {
    startGame();
  }
})();
</script>
</body>
</html>
